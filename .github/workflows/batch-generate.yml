name: ãƒãƒƒãƒè¨˜äº‹ç”Ÿæˆï¼ˆ30è¨˜äº‹ï¼‰

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã®ã¿
    inputs:
      article_count:
        description: 'ç”Ÿæˆã™ã‚‹è¨˜äº‹æ•°'
        required: false
        default: '30'
        type: string

jobs:
  batch-generate:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # æœ€å¤§60åˆ†
    concurrency:
      group: batch-generation
      cancel-in-progress: false
    
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm ci || npm install
        timeout-minutes: 5
      
      - name: OpenAI API Key ãƒã‚§ãƒƒã‚¯
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "Error: OPENAI_API_KEY is not set"
            exit 1
          fi
      
      - name: è¨˜äº‹ã‚’ãƒãƒƒãƒç”Ÿæˆ
        id: batch_generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          ARTICLE_COUNT=${{ github.event.inputs.article_count || '30' }}
          echo "ç”Ÿæˆã™ã‚‹è¨˜äº‹æ•°: $ARTICLE_COUNT"
          
          node scripts/generate-batch.js $ARTICLE_COUNT || {
            echo "ãƒãƒƒãƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™..."
            sleep 30
            node scripts/generate-batch.js $ARTICLE_COUNT
          }
      
      - name: ã‚µã‚¤ãƒˆãƒãƒƒãƒ—ç”Ÿæˆ
        if: success()
        run: |
          node scripts/generate-sitemap.js || echo "ã‚µã‚¤ãƒˆãƒãƒƒãƒ—ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸãŒç¶šè¡Œã—ã¾ã™"
      
      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—
          git fetch origin main
          git pull origin main --rebase || {
            echo "Pull failed, trying to merge"
            git rebase --abort 2>/dev/null || true
            git pull origin main --no-rebase
          }
          
          # å¤‰æ›´ã‚’è¿½åŠ 
          git add -A
          
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if ! git diff --quiet || ! git diff --staged --quiet; then
            ARTICLE_COUNT=${{ github.event.inputs.article_count || '30' }}
            git commit -m "ğŸš€ ãƒãƒƒãƒç”Ÿæˆ: ${ARTICLE_COUNT}è¨˜äº‹ã‚’è¿½åŠ "
          else
            echo "å¤‰æ›´ãŒãªã„ãŸã‚ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi
      
      - name: ãƒ—ãƒƒã‚·ãƒ¥
        if: success()
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          force: false
      
      - name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—æ™‚ã®é€šçŸ¥
        if: failure()
        run: |
          echo "::error::ãƒãƒƒãƒè¨˜äº‹ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "å¤±æ•—ã—ãŸã‚¹ãƒ†ãƒƒãƒ—: ${{ steps.batch_generate.outcome }}"
